import{b as i,d as H,e as h}from"./chunk-7EOUKLQR.js";import"./chunk-EPFUMVT3.js";import{HTTPException as re}from"hono/http-exception";import{Hono as oe}from"hono/tiny";import{validator as c}from"hono/validator";import{array as B,literal as U,minLength as k,object as D,pipe as F,safeParse as N,string as Q,union as X}from"valibot";var Y=D({tags:X([F(B(Q()),k(1)),U("all")])});async function b(e){let{output:n,success:t}=N(Y,await e.req.json(),{abortEarly:!0});return t?n:e.text("Invalid input",400)}import{parseDuration as g,parseSize as z,Server as G}from"@prisma/query-plan-executor";import{version as y}from"@prisma/query-plan-executor";var S;async function E(e){return S===void 0&&(S=await G.create({databaseUrl:e.get("db").connectionString,maxResponseSize:z("128 MiB"),queryTimeout:g("PT5M"),maxTransactionTimeout:g("PT5M"),maxTransactionWaitTime:g("PT5M"),perRequestLogContext:{logFormat:"text",logLevel:e.get("debug")?"debug":"off"}})),S}import{Buffer as O}from"buffer";import{produceSchema as W}from"@mrleebo/prisma-ast";var f=new Map;async function T(e){let t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(s=>s.toString(16).padStart(2,"0")).join("")}function w(e){let n=e.req.param("schemaHash"),t=f.get(n);return t==null?e.json({EngineNotStarted:{reason:"SchemaMissing"}},404):{schemaHash:n,schemas:t}}async function x(e,n,t){let r=O.from(e,"base64").toString("utf8"),o=W(r,s=>{s.datasource('"postgresql"',n.toString())});t&&console.log("[Accelerate] schema with override:",o);let a=await T(o);return{base64Override:O.from(o,"utf8").toString("base64"),overrideHash:a}}function d(e){let{req:n}=e;return{traceparent:n.header("traceparent"),"X-capture-telemetry":n.header("X-capture-telemetry")}}import{integer as I,looseObject as K,minValue as C,number as v,object as J,optional as Z,pipe as q,safeParse as R,string as A,union as ee}from"valibot";var te=J({isolation_level:Z(A()),max_wait:q(v(),I(),C(0)),timeout:q(v(),I(),C(0))});async function _(e){let{issues:n,output:t,success:r}=R(te,await e.req.json(),{abortEarly:!0});return r?t:e.json({EngineNotStarted:{reason:"InvalidRequest",issues:n}},400)}var ne=K({id:ee([A(),v()])});function M(e,n){let{output:t,success:r}=R(ne,e);return r?t:n.json({EngineMalfunction:{}},500)}var l=new oe;l.post("/invalidate",c("header",i),async e=>{let n=await b(e);return n instanceof Response?n:e.body(null)});var ae="/:clientVersion/:schemaHash",u=l.basePath(ae);l.route("/",u);var se=["/graphql","/itx/:transactionId/graphql"];u.on("POST",[...se],c("header",i),async e=>{let{req:n}=e;try{let t=await P(e);if(t instanceof Response)return t;let r=await n.text(),o=n.param("transactionId"),a=await t.request(r,{...d(e),"X-transaction-id":o});return e.text(a)}catch(t){return h(t,e)}});u.basePath("/itx/:transactionId").on("POST",["/commit","/rollback"],c("header",i),async e=>{let{req:n}=e;try{let t=await P(e);if(t instanceof Response)return t;let o=`${n.routePath.split("/").filter(Boolean).at(-1)}Transaction`,a=n.param("transactionId"),s=await t[o](a,d(e));return e.json(s)}catch(t){return h(t,e)}});u.put("/schema",c("header",i),async e=>{let{req:n}=e,t=await n.text();if(!t)return e.text("Missing schema",400);let r=n.param("schemaHash"),o=f.get(r);if(o==null){if(r!==await T(t))return e.text("Schema hash mismatch",400);let a=await x(t,e.get("db").prismaORMConnectionString,e.get("debug"));return f.set(r,{base64Original:t,...a}),e.text(r)}return t!==o.base64Original?e.text("Schema mismatch",400):e.text(r)});u.post("/transaction/start",c("header",i),async e=>{let{req:n}=e,t=await _(e);if(t instanceof Response)return t;try{let r=await P(e);if(r instanceof Response)return r;let o=await r.startTransaction(t,d(e)),a=M(o,e);if(a instanceof Response)return a;let{id:s}=a,V=n.param("clientVersion"),$=e.get("port"),j=e.get("protocol"),L=n.param("schemaHash");return e.json({...o,"data-proxy":{endpoint:`${j}://localhost:${$}/${V}/${L}/itx/${s}`}})}catch(r){return h(r,e)}});async function P(e){let{req:n}=e,t=w(e);if(t instanceof Response)return t;let{base64Override:r,overrideHash:o}=t.schemas;return await H.get({base64Schema:r,clientVersion:process.env.PRISMA_DEV_FORCE_CLIENT_VERSION||n.param("clientVersion"),debug:e.get("debug"),platform:e.get("platform"),schemaHash:o})}var ie=[["/connection-info","GET"],["/query","POST"],["/transaction/start","POST"],["/transaction/:transactionId/commit","POST"],["/transaction/:transactionId/query","POST"],["/transaction/:transactionId/rollback","POST"]];for(let[e,n]of ie)l.on(n,e,c("header",i),async t=>{let r=t.req.header("prisma-engine-hash");if(r!=="0.0.0"&&r!==y)throw new re(400,{message:`Using an HTTP connection string is not supported with Prisma Client version ${r} by this version of \`prisma dev\`. Please either use a direct TCP connection string or upgrade your client to version ${y}.`});return await(await E(t)).fetch(t.req.raw)});export{l as accelerateRoute};
